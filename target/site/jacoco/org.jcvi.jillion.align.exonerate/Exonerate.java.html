<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Exonerate.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jillion</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.align.exonerate</a> &gt; <span class="el_source">Exonerate.java</span></div><h1>Exonerate.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Jillion development code
 * 
 * This code may be freely distributed and modified under the
 * terms of the GNU Lesser General Public Licence.  This should
 * be distributed with the code.  If you do not have a copy,
 *  see:
 * 
 *          http://www.gnu.org/copyleft/lesser.html
 * 
 * 
 * Copyright for this code is held jointly by the individual authors.  These should be listed in the @author doc comments.
 * 
 * Information about Jillion can be found on its homepage
 * 
 *         http://jillion.sourceforge.net
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.align.exonerate;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Pattern;

import org.jcvi.jillion.align.exonerate.vulgar.VulgarElement;
import org.jcvi.jillion.align.exonerate.vulgar.VulgarOperation;
import org.jcvi.jillion.align.exonerate.vulgar.VulgarProtein2Genome;
import org.jcvi.jillion.core.DirectedRange;
import org.jcvi.jillion.core.Range.CoordinateSystem;
import org.jcvi.jillion.core.io.InputStreamSupplier;
import org.jcvi.jillion.core.io.PushBackBufferedReader;
import org.jcvi.jillion.core.residue.Frame;

<span class="nc" id="L41">public class Exonerate {</span>

<span class="nc" id="L43">    public enum FragmentType {</span>

<span class="nc" id="L45">        EXON,</span>
<span class="nc" id="L46">        INTRON,</span>
<span class="nc" id="L47">        SPLICE_SITE_5,</span>
<span class="nc" id="L48">        SPLICE_SITE_3</span>
    }

<span class="nc" id="L51">    private static class FragmentInfo{</span>
        private DirectedRange directedRange;
        private FragmentType type;
        private Frame frame;
    }
    
<span class="nc" id="L57">    private static class AlignmentFragment{</span>
        private FragmentInfo queryInfo, targetInfo;
    }
    
    public static List&lt;VulgarProtein2Genome&gt; parseVulgarOutput(File vulgarOutput) throws IOException{
<span class="nc" id="L62">        return parseVulgarOutput(InputStreamSupplier.forFile(vulgarOutput));</span>
    }
    
<span class="nc" id="L65">    private static String BLOCK_START = &quot;C4 Alignment:&quot;;</span>
    
    public static List&lt;VulgarProtein2Genome&gt; parseVulgarOutput(InputStreamSupplier vulgarOutput) throws IOException{
<span class="nc" id="L68">        List&lt;VulgarProtein2Genome&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L69">        try(PushBackBufferedReader reader = new PushBackBufferedReader(new BufferedReader(new InputStreamReader(vulgarOutput.get())))){</span>
            
<span class="nc" id="L71">            String currentBlock = readNextBlock(reader);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            while(currentBlock !=null){</span>
<span class="nc" id="L73">                System.out.println(&quot;===================BLOCK BEGIN===========&quot;);</span>
<span class="nc" id="L74">                System.out.println(currentBlock);</span>
<span class="nc" id="L75">                System.out.println(&quot;===================BLOCK END===========&quot;);</span>
                
<span class="nc" id="L77">                VulgarProtein2Genome v = handleBlock(currentBlock);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                if(v!=null){</span>
<span class="nc" id="L79">                    list.add(v);</span>
                }
<span class="nc" id="L81">                currentBlock = readNextBlock(reader);</span>
<span class="nc" id="L82">            }</span>
<span class="nc bnc" id="L83" title="All 8 branches missed.">        }</span>
<span class="nc" id="L84">        return list;</span>
    }
    
    private static VulgarProtein2Genome handleBlock(String block) throws IOException{
<span class="nc" id="L88">        Pattern splitPattern = Pattern.compile(&quot;\\s+&quot;);</span>
<span class="nc" id="L89">        try(BufferedReader reader = new BufferedReader(new StringReader(block))){</span>
            String line;
<span class="nc bnc" id="L91" title="All 2 branches missed.">            while( (line = reader.readLine()) !=null){</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if(line.startsWith(&quot;vulgar:&quot;)){</span>
<span class="nc" id="L93">                    String[] fields = splitPattern.split(line);</span>
                    //fields[0] is vulgar:
                    /*
                     * 

    query_id
        Query identifier
    query_start
        Query position at alignment start
    query_end
        Query position alignment end
    query_strand
        Strand of query matched
    target_id
        |
    target_start
        | the same 4 fields
    target_end
        | for the target sequence
    target_strand
        |
    score
        The raw alignment score


                     */
<span class="nc" id="L119">                    String queryId = fields[1];</span>
<span class="nc" id="L120">                    DirectedRange queryRange = DirectedRange.parse(Long.parseLong(fields[2]), Long.parseLong(fields[3]),</span>
                            CoordinateSystem.SPACE_BASED);
<span class="nc" id="L122">                    String queryStrand = fields[4];</span>
                    
<span class="nc" id="L124">                    String targetId = fields[5];</span>
<span class="nc" id="L125">                    DirectedRange targetRange = DirectedRange.parse(Long.parseLong(fields[6]), Long.parseLong(fields[7]),</span>
                            CoordinateSystem.SPACE_BASED);
<span class="nc" id="L127">                    String targetStrand = fields[8];</span>
                    
<span class="nc" id="L129">                    float score = Float.parseFloat(fields[9]);</span>
                    
<span class="nc" id="L131">                    List&lt;VulgarElement&gt; vulgarElements = new ArrayList&lt;&gt;((fields.length -10)/3);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                    for(int i= 10; i &lt; fields.length; i+=3){</span>
<span class="nc" id="L133">                        vulgarElements.add(new VulgarElement(VulgarOperation.getByCode(fields[i]),</span>
<span class="nc" id="L134">                                Integer.parseInt(fields[i+1]), </span>
<span class="nc" id="L135">                                Integer.parseInt(fields[i+2])));</span>
                    }
                    
<span class="nc" id="L138">                    System.out.println(&quot;query = &quot; + queryId + &quot;  &quot; + queryRange + &quot;  strand = &quot; + queryStrand);</span>
                    
<span class="nc" id="L140">                    System.out.println(&quot;target = &quot; + targetId + &quot;  &quot; + targetRange + &quot;  strand = &quot; + targetStrand);</span>
                    
<span class="nc" id="L142">                    System.out.println(score);</span>
                    
<span class="nc" id="L144">                    System.out.println(vulgarElements);</span>
                    
<span class="nc" id="L146">                    VulgarProtein2Genome v = new VulgarProtein2Genome(queryId, targetId, vulgarElements, score,</span>
                            queryStrand, queryRange, targetStrand, targetRange);
                    
                  
                    
<span class="nc" id="L151">                    return v;</span>
                }
            }
<span class="nc bnc" id="L154" title="All 12 branches missed.">        }</span>
<span class="nc" id="L155">        return null;</span>
    }

    private static String readNextBlock(PushBackBufferedReader reader) throws IOException {
        String line;
<span class="nc bnc" id="L160" title="All 2 branches missed.">        while( (line = reader.readLine()) !=null){</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if(BLOCK_START.equals(line)){</span>
                //found beginning
<span class="nc" id="L163">                break;</span>
            }
        }
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if(line ==null){</span>
<span class="nc" id="L167">            return null;</span>
        }
        
        
<span class="nc" id="L171">        StringBuilder builder = new StringBuilder(5000);</span>
<span class="nc" id="L172">        builder.append(line).append('\n');</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        while( (line = reader.readLine()) !=null){</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if(BLOCK_START.equals(line)){</span>
                //found end
<span class="nc" id="L176">                reader.pushBack(line);</span>
<span class="nc" id="L177">                break;</span>
            }else{
<span class="nc" id="L179">                builder.append(line).append('\n');</span>
            }
        }
<span class="nc" id="L182">        return builder.toString();</span>
    }
    
   
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>