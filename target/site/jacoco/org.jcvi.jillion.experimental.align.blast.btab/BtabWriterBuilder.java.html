<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BtabWriterBuilder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jillion</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.experimental.align.blast.btab</a> &gt; <span class="el_source">BtabWriterBuilder.java</span></div><h1>BtabWriterBuilder.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Jillion development code
 * 
 * This code may be freely distributed and modified under the
 * terms of the GNU Lesser General Public License.  This should
 * be distributed with the code.  If you do not have a copy,
 *  see:
 * 
 *          http://www.gnu.org/copyleft/lesser.html
 * 
 * 
 * Copyright for this code is held jointly by the individual authors.  These should be listed in the @author doc comments.
 * 
 * Information about Jillion can be found on its homepage
 * 
 *         http://jillion.sourceforge.net
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.experimental.align.blast.btab;

import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.math.RoundingMode;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Objects;

import org.jcvi.jillion.core.DirectedRange;
import org.jcvi.jillion.core.Direction;
import org.jcvi.jillion.core.Range;
import org.jcvi.jillion.core.Range.CoordinateSystem;
import org.jcvi.jillion.core.io.IOUtil;
import org.jcvi.jillion.core.util.JoinedStringBuilder;
import org.jcvi.jillion.experimental.align.blast.BlastHit;
import org.jcvi.jillion.experimental.align.blast.Hsp;

/**
 * {@code BtabWriterBuilder} will build an instance of
 * {@link BtabWriter} using the given configuration options.
 * @author dkatzel
 *
 */
public final class BtabWriterBuilder {

	private final File outputFile;
	private final OutputStream outStream;

<span class="nc" id="L57">	private Date runDate = new Date();</span>
<span class="nc" id="L58">	private boolean includePvalue=true;</span>
	
<span class="nc" id="L60">	private Locale locale = Locale.getDefault();</span>
	/**
	 * Create a new Builder object that will
	 * write the Btab formatted data to the given File.
	 * 
	 * @param outputFile the output file to write to;
	 * can not be null. If the File already exists, it will be overwritten.
	 * @throws NullPointerException if outputFile is null.
	 */
<span class="nc" id="L69">	public BtabWriterBuilder(File outputFile) {</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">		if(outputFile ==null){</span>
<span class="nc" id="L71">			throw new NullPointerException();</span>
		}
<span class="nc" id="L73">		this.outputFile = outputFile;</span>
<span class="nc" id="L74">		this.outStream = null;</span>
<span class="nc" id="L75">	}</span>
	
	/**
	 * Change the {@link Locale} used in date formatting
	 * of field #2.  If this method is not called, then
	 * the default locale is used.
	 * 
	 * @param locale the {@link Locale} to use; can not be null.
	 * @return this
	 * 
	 * @throws NullPointerException if locale is null.
	 * 
	 * @since 5.0
	 */
	public BtabWriterBuilder locale(Locale locale){
<span class="nc" id="L90">		Objects.requireNonNull(locale);</span>
<span class="nc" id="L91">		this.locale=locale;</span>
<span class="nc" id="L92">		return this;</span>
	}
	/**
	 * Create a new Builder object that will
	 * write the Btab formatted data to the given OutputStream.
	 * When the {@link BtabWriter} is closed, the OutputStream will
	 * also be closed.
	 * 
	 * @param out the outputSream to write to;
	 * can not be null. If the File already exists, it will be overwritten.
	 * @throws NullPointerException if outputFile is null.
	 */
<span class="nc" id="L104">	public BtabWriterBuilder(OutputStream out) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if(out ==null){</span>
<span class="nc" id="L106">			throw new NullPointerException();</span>
		}
<span class="nc" id="L108">		this.outputFile = null;</span>
<span class="nc" id="L109">		this.outStream = out;</span>
<span class="nc" id="L110">	}</span>
	
	/**
	 * Sets the date for field #2 in the btab output.
	 * If this method is not set, then the Date used
	 * is the current date.
	 * @param date the Date to write out, can not be null.
	 * @return this.
	 * @throws NullPointerException if date is null.
	 * 
	 * @see #locale(Locale)
	 */
	public BtabWriterBuilder setRunDate(Date date){
<span class="nc bnc" id="L123" title="All 2 branches missed.">		if(date ==null){</span>
<span class="nc" id="L124">			throw new NullPointerException();</span>
		}
<span class="nc" id="L126">		this.runDate = new Date(date.getTime());</span>
<span class="nc" id="L127">		return this;</span>
	}
	/**
	 * Should the trailing P-value get included
	 * as the last field in the btab output.
	 * Many parsers ignore the last field because
	 * the p-value is often not available.
	 * If this method is not called, then the p-value
	 * &lt;em&gt;is&lt;/em&gt; included by default.
	 * 
	 * @param includePvalue {@code true} if the p-value should be included;
	 * {@code false} otherwise.
	 * 
	 * @return this
	 */
	public BtabWriterBuilder includePvalue(boolean includePvalue){
<span class="nc" id="L143">		this.includePvalue = includePvalue;</span>
<span class="nc" id="L144">		return this;</span>
	}
	/**
	 * Create a new {@link BtabWriter} instance
	 * using the configuration so far.
	 * The returned BtabWriter implementation is 
	 * NOT thread-safe.
	 * @return a new {@link BtabWriter} instance;
	 * will never be null.
	 * @throws IOException if there is a problem creating 
	 * the outputFile if {@link #BtabWriterBuilder(File)}
	 * contructor was used.
	 */
	public BtabWriter build() throws IOException{
<span class="nc" id="L158">		return new BtabWriterImpl(this);</span>
	}
	
	
	private static final class BtabWriterImpl implements BtabWriter{

		private final PrintWriter out;
		private final String formattedRunDate;
		
		private final NumberFormat scientificNotationFormatter;
		private final boolean includePvalue;
		
<span class="nc" id="L170">		private BtabWriterImpl(BtabWriterBuilder builder) throws IOException{</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if(builder.outputFile ==null){</span>
<span class="nc" id="L172">				out = new PrintWriter(IOUtil.createNewBufferedWriter(builder.outStream, IOUtil.UTF_8_NAME));</span>
			}else{
<span class="nc" id="L174">				out = new PrintWriter(IOUtil.createNewBufferedWriter(builder.outputFile, IOUtil.UTF_8_NAME));</span>
			}
			//create new date formatter each time to avoid
			//thread related problems.  
			//this constructor should only be called in frequently
			//so it won't be too much of a performance hit.
<span class="nc" id="L180">			formattedRunDate = new SimpleDateFormat(&quot;MMM dd yyyy&quot;, builder.locale).format(builder.runDate);</span>
			
<span class="nc" id="L182">			scientificNotationFormatter = new DecimalFormat(&quot;0.0E0&quot;);</span>
<span class="nc" id="L183">			scientificNotationFormatter.setRoundingMode(RoundingMode.HALF_UP);</span>
<span class="nc" id="L184">			scientificNotationFormatter.setMinimumFractionDigits(5);</span>
			
<span class="nc" id="L186">			this.includePvalue = builder.includePvalue;</span>
<span class="nc" id="L187">		}</span>
		@Override
		public void close() throws IOException {
<span class="nc" id="L190">			out.close();</span>
			
<span class="nc" id="L192">		}</span>

		@Override
		public void write(BlastHit hit) throws IOException {
				
				
<span class="nc bnc" id="L198" title="All 2 branches missed.">				for(Hsp&lt;?,?,?&gt; hsp : hit.getHsps()){</span>

<span class="nc" id="L200">					List&lt;String&gt; fields = new ArrayList&lt;String&gt;(21);</span>
<span class="nc" id="L201">					fields.add(hsp.getQueryId());</span>
<span class="nc" id="L202">					fields.add(formattedRunDate); //date? current date?</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">					fields.add(hsp.getQueryLength()==null?&quot;&quot;:hsp.getQueryLength().toString());</span>
<span class="nc" id="L204">					fields.add(hit.getBlastProgramName());</span>
<span class="nc" id="L205">					fields.add(hit.getBlastDbName());</span>
<span class="nc" id="L206">					fields.add(hsp.getSubjectId());</span>
<span class="nc" id="L207">					DirectedRange queryDirectedRange = hsp.getQueryRange();</span>
<span class="nc" id="L208">					DirectedRange subjectDirectedRange = hsp.getSubjectRange();</span>
					
					
<span class="nc" id="L211">					appendRangeCoordinates(queryDirectedRange, fields);</span>
<span class="nc" id="L212">					appendRangeCoordinates(subjectDirectedRange, fields);</span>
					
					
					//double alignmentLength = hsp.getNumberOfMismatches() + hsp.getNumberOfPositiveMatches()+hsp.getNumberOfGapOpenings();
<span class="nc" id="L216">					double alignmentLength = hsp.getAlignmentLength();</span>
<span class="nc" id="L217">					fields.add(String.format(&quot;%.2f&quot;, hsp.getNumberOfIdentitcalMatches()/alignmentLength*100D));</span>
					
<span class="nc" id="L219">					fields.add(String.format(&quot;%.2f&quot;, hsp.getNumberOfPositiveMatches()/alignmentLength*100D));</span>
					
<span class="nc bnc" id="L221" title="All 2 branches missed.">					fields.add(hsp.getHspScore()==null?&quot;0.0&quot; : hsp.getHspScore().toString());</span>
					
					
<span class="nc" id="L224">					fields.add(hsp.getBitScore().toString());</span>
					//VHTNGS-1125 - add alignment length to output.
					//This differs from VICS.  VICS had blank column
<span class="nc" id="L227">					fields.add(Integer.toString((int)alignmentLength));</span>
					//hit def?
<span class="nc bnc" id="L229" title="All 2 branches missed.">					fields.add(hsp.getSubjectDefinition() ==null?&quot;&quot;:hsp.getSubjectDefinition());</span>
					//frame?
					//this will make frame 1,2,3,-1,-2,-3
<span class="nc bnc" id="L232" title="All 2 branches missed.">					fields.add(hsp.getHitFrame() ==null?&quot;&quot;: Integer.toString(hsp.getHitFrame()) );</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">					fields.add(queryDirectedRange.getDirection()==Direction.FORWARD? &quot;Plus&quot; : &quot;Minus&quot;);</span>
<span class="nc" id="L234">					fields.add(Integer.toString(hsp.getSubjectLength()));</span>
					//add extra trailing tab to match vics output
<span class="nc" id="L236">					String formattedEvalue = scientificNotationFormatter.format(hsp.getEvalue());</span>
					
					
<span class="nc bnc" id="L239" title="All 2 branches missed.">					if(includePvalue){</span>
<span class="nc" id="L240">						fields.add(formattedEvalue);</span>
<span class="nc" id="L241">						fields.add(formattedEvalue);</span>
					}else{
<span class="nc" id="L243">						fields.add(formattedEvalue + &quot;\t&quot;);</span>
					}
					
<span class="nc" id="L246">					out.println(JoinedStringBuilder.create(fields).glue(&quot;\t&quot;).build());</span>
<span class="nc" id="L247">				}</span>
			
			
<span class="nc" id="L250">		}</span>
		/**
		 * flip begin and end coords if hit is reversed
		 */	
		private void appendRangeCoordinates(DirectedRange directedRange,
				List&lt;String&gt; fields) {
<span class="nc" id="L256">			Range range =directedRange.getRange();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">			if(directedRange.getDirection() == Direction.FORWARD){		</span>
<span class="nc" id="L258">				fields.add(Long.toString(range.getBegin(CoordinateSystem.RESIDUE_BASED)));</span>
<span class="nc" id="L259">				fields.add(Long.toString(range.getEnd(CoordinateSystem.RESIDUE_BASED)));					</span>
			}else{
<span class="nc" id="L261">				fields.add(Long.toString(range.getEnd(CoordinateSystem.RESIDUE_BASED)));	</span>
<span class="nc" id="L262">				fields.add(Long.toString(range.getBegin(CoordinateSystem.RESIDUE_BASED)));					</span>
			}
<span class="nc" id="L264">		}</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>