<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractLargeFastaFileDataStore.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jillion</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.internal.fasta</a> &gt; <span class="el_source">AbstractLargeFastaFileDataStore.java</span></div><h1>AbstractLargeFastaFileDataStore.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Jillion development code
 * 
 * This code may be freely distributed and modified under the
 * terms of the GNU Lesser General Public License.  This should
 * be distributed with the code.  If you do not have a copy,
 *  see:
 * 
 *          http://www.gnu.org/copyleft/lesser.html
 * 
 * 
 * Copyright for this code is held jointly by the individual authors.  These should be listed in the @author doc comments.
 * 
 * Information about Jillion can be found on its homepage
 * 
 *         http://jillion.sourceforge.net
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.internal.fasta;

import java.io.IOException;
import java.util.function.Consumer;
import java.util.function.Predicate;

import org.jcvi.jillion.core.Sequence;
import org.jcvi.jillion.core.datastore.DataStore;
import org.jcvi.jillion.core.datastore.DataStoreClosedException;
import org.jcvi.jillion.core.datastore.DataStoreEntry;
import org.jcvi.jillion.core.datastore.DataStoreException;
import org.jcvi.jillion.core.io.IOUtil;
import org.jcvi.jillion.core.util.iter.StreamingIterator;
import org.jcvi.jillion.core.util.streams.ThrowingBiConsumer;
import org.jcvi.jillion.fasta.FastaDataStore;
import org.jcvi.jillion.fasta.FastaParser;
import org.jcvi.jillion.fasta.FastaRecord;
import org.jcvi.jillion.fasta.FastaRecordVisitor;
import org.jcvi.jillion.fasta.FastaVisitor;
import org.jcvi.jillion.fasta.FastaVisitorCallback;
import org.jcvi.jillion.internal.core.datastore.DataStoreStreamingIterator;
import org.jcvi.jillion.internal.core.util.Sneak;
public abstract class AbstractLargeFastaFileDataStore&lt;T,S extends Sequence&lt;T&gt;, F extends FastaRecord&lt;T, S&gt;, D extends DataStore&lt;S&gt;&gt; implements FastaDataStore&lt;T,S,F,D&gt;{

    
    private final FastaParser parser;
    private final Predicate&lt;String&gt; filter;
    private final Predicate&lt;F&gt; recordFilter;
    private Long size;
<span class="fc" id="L50">    private volatile boolean closed=false;</span>
    
    /**
     * Construct a {@link AbstractLargeFastaFileDataStore} using
     * the given fasta file and filter.
     * @param fastaFile the Fasta File to use, can not be null.
     * @throws NullPointerException if fastaFile is null.
     */
<span class="fc" id="L58">    protected AbstractLargeFastaFileDataStore(FastaParser parser, Predicate&lt;String&gt; filter, Predicate&lt;F&gt; recordFilter) {</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if(parser ==null){</span>
<span class="nc" id="L60">            throw new NullPointerException(&quot;fasta parser can not be null&quot;);</span>
        }
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if(filter ==null){</span>
<span class="nc" id="L63">            throw new NullPointerException(&quot;filter file can not be null&quot;);</span>
        }
<span class="fc" id="L65">        this.filter =filter;</span>
<span class="fc" id="L66">        this.parser = parser;</span>
<span class="fc" id="L67">        this.recordFilter = recordFilter;</span>
<span class="fc" id="L68">    }</span>
    
    private void checkNotYetClosed(){
<span class="fc bfc" id="L71" title="All 2 branches covered.">        if(closed){</span>
<span class="fc" id="L72">            throw new DataStoreClosedException(&quot;already closed&quot;);</span>
        }
<span class="fc" id="L74">    }</span>


	@Override
    public  void close() throws IOException {
<span class="fc" id="L79">        closed=true;</span>
        
<span class="fc" id="L81">    }</span>

    @Override
    public  boolean isClosed() {
<span class="fc" id="L85">        return closed;</span>
    }

    @Override
    public boolean contains(String id) throws DataStoreException {
<span class="fc" id="L90">        checkNotYetClosed();</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        return get(id)!=null;</span>
    }

    @Override
    public F get(String id)
            throws DataStoreException {
<span class="fc" id="L97">        StreamingIterator&lt;F&gt; iter = iterator();</span>
        try{
<span class="fc bfc" id="L99" title="All 2 branches covered.">	        while(iter.hasNext()){</span>
<span class="fc" id="L100">	        	F next = iter.next();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">	        	if(next.getId().equals(id)){</span>
<span class="fc" id="L102">	        		return next;</span>
	        	}
<span class="fc" id="L104">	        }</span>
	        //we get here if we didn't find it
<span class="fc" id="L106">	        return null;</span>
        }finally{
<span class="pc" id="L108">        	IOUtil.closeAndIgnoreErrors(iter);</span>
        }
    }

    protected abstract FastaRecordVisitor createRecordVisitor(String id, String comment, Consumer&lt;F&gt; callback);
    
    @Override
    public &lt;E extends Throwable&gt; void forEach(ThrowingBiConsumer&lt;String, F, E&gt; consumer) throws IOException, E {
<span class="nc" id="L116">        checkNotYetClosed();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if(recordFilter ==null){</span>
<span class="nc" id="L118">            parser.parse(new FastaVisitor() {</span>
                
                @Override
                public void visitEnd() {
                    
<span class="nc" id="L123">                }</span>
                
                @Override
                public FastaRecordVisitor visitDefline(FastaVisitorCallback callback,
                        String id, String optionalComment) {
<span class="nc bnc" id="L128" title="All 2 branches missed.">                    if(filter.test(id)){</span>
<span class="nc" id="L129">                        return createRecordVisitor(id, optionalComment, r-&gt;{</span>
                           try{
<span class="nc" id="L131">                               consumer.accept(id, r);</span>
<span class="nc" id="L132">                           }catch(Throwable t){</span>
<span class="nc" id="L133">                               Sneak.sneakyThrow(t);</span>
<span class="nc" id="L134">                           }</span>
<span class="nc" id="L135">                        });</span>
                          
                    }
                    
<span class="nc" id="L139">                    return null;</span>
                }
                
                @Override
                public void halted() {
                   
                    
<span class="nc" id="L146">                }</span>
            });
        }
        else{
<span class="nc" id="L150">            parser.parse(new FastaVisitor() {</span>
                
                @Override
                public void visitEnd() {
                    
<span class="nc" id="L155">                }</span>
                
                @Override
                public FastaRecordVisitor visitDefline(FastaVisitorCallback callback,
                        String id, String optionalComment) {
<span class="nc bnc" id="L160" title="All 2 branches missed.">                    if(filter.test(id)){</span>
<span class="nc" id="L161">                        return createRecordVisitor(id, optionalComment, </span>
                                r-&gt; {
<span class="nc bnc" id="L163" title="All 2 branches missed.">                                    if(recordFilter.test(r)){</span>
                                        try{
<span class="nc" id="L165">                                            consumer.accept(id, r);</span>
<span class="nc" id="L166">                                        }catch(Throwable t){</span>
<span class="nc" id="L167">                                            Sneak.sneakyThrow(t);</span>
<span class="nc" id="L168">                                        }</span>
                                    }
<span class="nc" id="L170">                                });</span>
                                
                          
                    }
                    
<span class="nc" id="L175">                    return null;</span>
                }
                
                @Override
                public void halted() {
                   
                    
<span class="nc" id="L182">                }</span>
            });
        }

<span class="nc" id="L186">    }</span>

    @Override
    public StreamingIterator&lt;String&gt; idIterator() throws DataStoreException {
<span class="fc" id="L190">        checkNotYetClosed();</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if(recordFilter==null){</span>
<span class="fc" id="L192">            return DataStoreStreamingIterator.create(this,LargeFastaIdIterator.createNewIteratorFor(parser,filter));</span>
        }
        
<span class="nc" id="L195">        return new AdditionalRecordFilteringIdIterator(iterator());</span>
    }

    @Override
    public synchronized long getNumberOfRecords() throws DataStoreException {
<span class="fc" id="L200">        checkNotYetClosed();</span>
        
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if(size ==null){</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">            if(recordFilter ==null){</span>
                try {
<span class="fc" id="L205">                	NoAdditionalRecordFilteringSizeCounter visitor = new NoAdditionalRecordFilteringSizeCounter();      </span>
<span class="fc" id="L206">            		parser.parse(visitor);</span>
<span class="fc" id="L207">            		size = visitor.getSize();</span>
<span class="nc" id="L208">                } catch (IOException e) {</span>
<span class="nc" id="L209">                    throw new IllegalStateException(&quot;could not get record count&quot;,e);</span>
<span class="fc" id="L210">                }</span>
            }else{
<span class="fc" id="L212">                long temp=0;</span>
<span class="pc" id="L213">                try(StreamingIterator&lt;F&gt; iter = iterator()){</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                    while(iter.hasNext()){</span>
<span class="fc" id="L215">                        iter.next();</span>
<span class="fc" id="L216">                        temp++;</span>
                    }
<span class="pc bpc" id="L218" title="6 of 8 branches missed.">                }</span>
<span class="fc" id="L219">                size= temp;</span>
            }
        }   
<span class="fc" id="L222">        return size;</span>

    }
	

    @Override
    public final StreamingIterator&lt;F&gt; iterator() throws DataStoreException {
<span class="fc" id="L229">        checkNotYetClosed();</span>
<span class="fc" id="L230">        return createNewIterator(parser,filter, recordFilter);</span>
       
    }

	protected abstract StreamingIterator&lt;F&gt; createNewIterator(FastaParser parser ,Predicate&lt;String&gt; filter, Predicate&lt;F&gt; recordIterator) throws DataStoreException;
   

	@Override
	public final StreamingIterator&lt;DataStoreEntry&lt;F&gt;&gt; entryIterator()
			throws DataStoreException {
<span class="nc" id="L240">		checkNotYetClosed();</span>
<span class="nc" id="L241">		return new StreamingIterator&lt;DataStoreEntry&lt;F&gt;&gt;(){</span>
<span class="nc" id="L242">			StreamingIterator&lt;F&gt; iter = iterator();</span>
			@Override
			public boolean hasNext() {
<span class="nc" id="L245">				return iter.hasNext();</span>
			}

			@Override
			public void close() {
<span class="nc" id="L250">				iter.close();</span>
<span class="nc" id="L251">			}</span>

			@Override
			public DataStoreEntry&lt;F&gt; next() {
<span class="nc" id="L255">				F next = iter.next();</span>
<span class="nc" id="L256">				return new DataStoreEntry&lt;F&gt;(next.getId(), next);</span>
			}

			@Override
			public void remove() {
<span class="nc" id="L261">				iter.remove();</span>
<span class="nc" id="L262">			}</span>
			
		};
	}

<span class="fc" id="L267">	private final class NoAdditionalRecordFilteringSizeCounter implements FastaVisitor {</span>
<span class="fc" id="L268">	        long numDeflines=0L;</span>

	        @Override
	        public FastaRecordVisitor visitDefline(
	                        FastaVisitorCallback callback, String id,
	                        String optionalComment) {
<span class="fc bfc" id="L274" title="All 2 branches covered.">	                if(filter.test(id)){                                       </span>
<span class="fc" id="L275">	                        numDeflines++;</span>
	                }
	                
<span class="fc" id="L278">	                return null;</span>
	                
	        }

	        public long getSize(){
<span class="fc" id="L283">	        	return numDeflines;</span>
	        }
	        @Override
	        public void visitEnd() {
	        	//no-op
<span class="fc" id="L288">	        }</span>

	        @Override
	        public void halted() {
	                //this shouldn't happen
	                //throw an exception so we don't
	                //return a null value or try 
	                //to reparse the size 
	                //next time it's asked 
<span class="nc" id="L297">	                throw new IllegalStateException(&quot;parser was halted when trying to compute size&quot;);               </span>
	        }
	    }
	
	private final class AdditionalRecordFilteringIdIterator implements StreamingIterator&lt;String&gt; {
	        private final StreamingIterator&lt;F&gt; iter;

            @Override
            public boolean hasNext() {
<span class="nc" id="L306">                return iter.hasNext();</span>
            }

            @Override
            public void close() {
<span class="nc" id="L311">               iter.close();</span>
<span class="nc" id="L312">            }</span>

            @Override
            public String next() {
<span class="nc" id="L316">                return iter.next().getId();</span>
            }

<span class="nc" id="L319">            public AdditionalRecordFilteringIdIterator(StreamingIterator&lt;F&gt; iter) {</span>
<span class="nc" id="L320">                this.iter = iter;</span>
<span class="nc" id="L321">            }</span>
	        
	    }
   
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>