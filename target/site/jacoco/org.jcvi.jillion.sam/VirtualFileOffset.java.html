<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>VirtualFileOffset.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jillion</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.sam</a> &gt; <span class="el_source">VirtualFileOffset.java</span></div><h1>VirtualFileOffset.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Jillion development code
 * 
 * This code may be freely distributed and modified under the
 * terms of the GNU Lesser General Public License.  This should
 * be distributed with the code.  If you do not have a copy,
 *  see:
 * 
 *          http://www.gnu.org/copyleft/lesser.html
 * 
 * 
 * Copyright for this code is held jointly by the individual authors.  These should be listed in the @author doc comments.
 * 
 * Information about Jillion can be found on its homepage
 * 
 *         http://jillion.sourceforge.net
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.sam;

/**
 * {@code VirtualFileOffset} is an object
 * representation of a BAM virtual file offset
 * as defined in the SAM specification.
 * The VirutalFileOffset encodes a file offset
 * as two coordinates : the file offset into
 * the compressed BAM blocks and then an additional offset
 * into the &lt;em&gt;un&lt;/em&gt;compressed block.
 * @author dkatzel
 *
 */
public class VirtualFileOffset implements Comparable&lt;VirtualFileOffset&gt;{
	//2^49 -1
	private static final long MAX_COMPRESSED_BLOCK_OFFSET = 562949953421311L;
	//2^17 -1
	private static final int MAX_UNCOMPRESSED_OFFSET = 131071;
	private final long encodedValue;
	/**
	 * Create a new {@link VirtualFileOffset}
	 * instance using the given compressedBlock offset and 
	 * uncompressed offset into the current block.
	 * @param compressedBlockOffset the number of compressed bytes to read
	 * from the beginning of the BAM file until the current BGZF block is reached;
	 * must be &gt;=0 and less than 2&lt;sup&gt;49&lt;/sup&gt;-1.
	 * @param uncompressedOffset the number of &lt;em&gt;un&lt;/em&gt;compressed bytes 
	 * read in the current BGZF block; must be between 0 and 2&lt;sup&gt;17&lt;/sup&gt;-1.
	 * @return a new {@link VirtualFileOffset} instance; will never be null.
	 * @throws IllegalArgumentException if the provided offset values are out of range.
	 */
	public static VirtualFileOffset create(long compressedBlockOffset, int uncompressedOffset){
<span class="fc bfc" id="L53" title="All 2 branches covered.">		if(compressedBlockOffset &lt;0){</span>
<span class="fc" id="L54">			throw new IllegalArgumentException(&quot;compressed BlockOffset can not be negative : &quot; + compressedBlockOffset);</span>
		}
<span class="fc bfc" id="L56" title="All 2 branches covered.">		if(compressedBlockOffset &gt; MAX_COMPRESSED_BLOCK_OFFSET){</span>
<span class="fc" id="L57">			throw new IllegalArgumentException(&quot;compressed BlockOffset can not be larger than &quot; + MAX_COMPRESSED_BLOCK_OFFSET + &quot; : &quot; + compressedBlockOffset);</span>
		}
<span class="fc bfc" id="L59" title="All 2 branches covered.">		if(uncompressedOffset &lt;0){</span>
<span class="fc" id="L60">			throw new IllegalArgumentException(&quot;uncompressed offset can not be negative : &quot; + uncompressedOffset);</span>
		}
<span class="fc bfc" id="L62" title="All 2 branches covered.">		if(uncompressedOffset &gt; MAX_UNCOMPRESSED_OFFSET){</span>
<span class="fc" id="L63">			throw new IllegalArgumentException(&quot;uncompressed offset can not be larger than&quot; + MAX_UNCOMPRESSED_OFFSET + &quot; : &quot; + uncompressedOffset);</span>
		}
<span class="fc" id="L65">		long encodedValue = compressedBlockOffset &lt;&lt;16;</span>
<span class="fc" id="L66">		encodedValue |= uncompressedOffset;</span>
<span class="fc" id="L67">		return new VirtualFileOffset(encodedValue);</span>
	}
	/**
	 * Compute the next possible {@link VirtualFileOffset}  after this one.
	 * The returned value should only be used for comparison purposes
	 * and is not meant to be a valid next {@link VirtualFileOffset}
	 * in the BAM file.
	 * 
	 * @return a new {@link VirtualFileOffset}, will never be null.
	 * 
	 * @throws IllegalArgumentException if this {@link VirtualFileOffset}
	 * is the last possible offset allowed by the BAM spec which is highly unlikely.
	 * 
	 * @since 5.0
	 */
	public VirtualFileOffset nextOffset(){
<span class="nc" id="L83">		long compressedOffset = getCompressedBamBlockOffset();</span>
<span class="nc" id="L84">		int uncompressedOffset = getUncompressedOffset() +1;</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">		if(uncompressedOffset &gt; MAX_UNCOMPRESSED_OFFSET){</span>
<span class="nc" id="L86">			uncompressedOffset=0;</span>
<span class="nc" id="L87">			compressedOffset ++;</span>
		}
<span class="nc" id="L89">		return create(compressedOffset,uncompressedOffset);</span>
	}
	
<span class="fc" id="L92">	public VirtualFileOffset(long encodedValue) {</span>
<span class="fc" id="L93">		this.encodedValue = encodedValue;</span>
<span class="fc" id="L94">	}</span>
	
	
	
	public long getEncodedValue() {
<span class="fc" id="L99">		return encodedValue;</span>
	}

	public long getCompressedBamBlockOffset(){
<span class="fc" id="L103">		return encodedValue&gt;&gt;16;</span>
	}
	
	public int getUncompressedOffset(){
<span class="fc" id="L107">		return (int)(encodedValue &amp; 0xFFFF);</span>
	}

	@Override
	public int compareTo(VirtualFileOffset o) {
<span class="fc bfc" id="L112" title="All 2 branches covered.">		if( encodedValue &lt; o.encodedValue){</span>
<span class="fc" id="L113">			return -1;</span>
		}
<span class="fc bfc" id="L115" title="All 2 branches covered.">		if(encodedValue == o.encodedValue){</span>
<span class="fc" id="L116">			return 0;</span>
		}
<span class="fc" id="L118">		return 1;</span>
	}

	@Override
	public int hashCode() {
<span class="fc" id="L123">		final int prime = 31;</span>
<span class="fc" id="L124">		int result = 1;</span>
<span class="fc" id="L125">		result = prime * result + (int) (encodedValue ^ (encodedValue &gt;&gt;&gt; 32));</span>
<span class="fc" id="L126">		return result;</span>
	}

	@Override
	public boolean equals(Object obj) {
<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (this == obj) {</span>
<span class="fc" id="L132">			return true;</span>
		}
<span class="fc bfc" id="L134" title="All 2 branches covered.">		if (obj == null) {</span>
<span class="fc" id="L135">			return false;</span>
		}
<span class="fc bfc" id="L137" title="All 2 branches covered.">		if (!(obj instanceof VirtualFileOffset)) {</span>
<span class="fc" id="L138">			return false;</span>
		}
<span class="fc" id="L140">		VirtualFileOffset other = (VirtualFileOffset) obj;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">		if (encodedValue != other.encodedValue) {</span>
<span class="fc" id="L142">			return false;</span>
		}
<span class="fc" id="L144">		return true;</span>
	}

	@Override
	public String toString() {
<span class="nc" id="L149">		return &quot;VirtualFileOffset [getCompressedBamBlockOffset()=&quot;</span>
<span class="nc" id="L150">				+ getCompressedBamBlockOffset() + &quot;, getUncompressedOffset()=&quot;</span>
<span class="nc" id="L151">				+ getUncompressedOffset() + &quot;]&quot;;</span>
	}
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>