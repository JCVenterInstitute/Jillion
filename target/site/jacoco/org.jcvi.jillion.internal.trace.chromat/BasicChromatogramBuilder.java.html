<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BasicChromatogramBuilder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Jillion</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.internal.trace.chromat</a> &gt; <span class="el_source">BasicChromatogramBuilder.java</span></div><h1>BasicChromatogramBuilder.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Jillion development code
 * 
 * This code may be freely distributed and modified under the
 * terms of the GNU Lesser General Public License.  This should
 * be distributed with the code.  If you do not have a copy,
 *  see:
 * 
 *          http://www.gnu.org/copyleft/lesser.html
 * 
 * 
 * Copyright for this code is held jointly by the individual authors.  These should be listed in the @author doc comments.
 * 
 * Information about Jillion can be found on its homepage
 * 
 *         http://jillion.sourceforge.net
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
/*
 * Created on Jan 8, 2009
 *
 * @author dkatzel
 */
package org.jcvi.jillion.internal.trace.chromat;

import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;

import org.jcvi.jillion.core.pos.PositionSequence;
import org.jcvi.jillion.core.qual.PhredQuality;
import org.jcvi.jillion.core.qual.QualitySequence;
import org.jcvi.jillion.core.qual.QualitySequenceBuilder;
import org.jcvi.jillion.core.residue.nt.Nucleotide;
import org.jcvi.jillion.core.residue.nt.NucleotideSequence;
import org.jcvi.jillion.trace.chromat.ChannelGroup;
import org.jcvi.jillion.trace.chromat.Chromatogram;

public final class BasicChromatogramBuilder {
    
<span class="fc" id="L44">    private static final byte[] EMPTY_BYTE_ARRAY = new byte[]{};</span>
        private PositionSequence peaks;
        private NucleotideSequence basecalls;
        //default to empty confidences (which may happen if read is really
        //trashy
<span class="fc" id="L49">        private byte[] aQualities=EMPTY_BYTE_ARRAY;</span>
<span class="fc" id="L50">        private byte[] cQualities=EMPTY_BYTE_ARRAY;</span>
<span class="fc" id="L51">        private byte[] gConfidence=EMPTY_BYTE_ARRAY;</span>
<span class="fc" id="L52">        private byte[] tQualities=EMPTY_BYTE_ARRAY;</span>

        private short[] aPositions;
        private short[] cPositions;
        private short[] gPositions;
        private short[] tPositions;

        private Map&lt;String,String&gt; comments;
        
        private String id;
        /**
         * Set the id of this Builder.
         * @param id the id of this Builder; can not be null.
         * @throws NullPointerException if id is null.
         */
<span class="fc" id="L67">        public BasicChromatogramBuilder(String id){</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        	if(id ==null){</span>
<span class="nc" id="L69">        		throw new NullPointerException(&quot;id can not be null&quot;);</span>
        	}
<span class="fc" id="L71">        	this.id=id;</span>
<span class="fc" id="L72">        }</span>
        /**
         * Builds a builder starting with the following default values.
         * @param basecalls the basecalls may be null.
         * @param peaks the peaks cannot be null.
         * @param channelGroup the channel group containing
         *  position and confidence data on all 4 channels can not be null.
         * @param properties the properties may be null.
         */
        private BasicChromatogramBuilder(String id, NucleotideSequence basecalls,
<span class="fc" id="L82">        		PositionSequence peaks, ChannelGroup channelGroup, Map&lt;String,String&gt; properties){</span>
<span class="fc" id="L83">            id(id);</span>
<span class="fc" id="L84">        	basecalls(basecalls);</span>
<span class="fc" id="L85">            peaks(peaks);</span>
<span class="fc" id="L86">            channelGroup(channelGroup);           </span>
<span class="fc" id="L87">            comments(properties);</span>
<span class="fc" id="L88">        }</span>
        
        private void channelGroup(ChannelGroup channelGroup){
<span class="fc" id="L91">        	 aQualities =toByteArray(channelGroup.getAChannel().getQualitySequence());</span>
<span class="fc" id="L92">             aPositions =channelGroup.getAChannel().getPositionSequence().toArray();            </span>
<span class="fc" id="L93">             cQualities= toByteArray(channelGroup.getCChannel().getQualitySequence());</span>
<span class="fc" id="L94">             cPositions = channelGroup.getCChannel().getPositionSequence().toArray();</span>
<span class="fc" id="L95">             gConfidence = toByteArray(channelGroup.getGChannel().getQualitySequence());</span>
<span class="fc" id="L96">             gPositions = channelGroup.getGChannel().getPositionSequence().toArray();</span>
<span class="fc" id="L97">             tQualities =toByteArray(channelGroup.getTChannel().getQualitySequence());</span>
<span class="fc" id="L98">             tPositions = channelGroup.getTChannel().getPositionSequence().toArray();</span>
<span class="fc" id="L99">        }</span>
        private byte[] toByteArray(QualitySequence sequence){
<span class="fc" id="L101">        	byte[] array = new byte[(int)sequence.getLength()];</span>
<span class="fc" id="L102">        	int i=0;</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">        	for(PhredQuality q : sequence){</span>
<span class="fc" id="L104">        		array[i]=q.getQualityScore();</span>
<span class="fc" id="L105">        		i++;</span>
<span class="fc" id="L106">        	}</span>
<span class="fc" id="L107">        	return array;</span>
        }
        
       
        
        public BasicChromatogramBuilder(Chromatogram copy){
<span class="fc" id="L113">		       this(copy.getId(), copy.getNucleotideSequence(),</span>
<span class="fc" id="L114">		       copy.getPeakSequence(),</span>
<span class="fc" id="L115">		       copy.getChannelGroup(),</span>
<span class="fc" id="L116">		       copy.getComments()</span>
		       );
        
<span class="fc" id="L119">        }</span>
        public BasicChromatogramBuilder(String id, Chromatogram copy){
<span class="nc" id="L121">		       this(id, copy.getNucleotideSequence(),</span>
<span class="nc" id="L122">		       copy.getPeakSequence(),</span>
<span class="nc" id="L123">		       copy.getChannelGroup(),</span>
<span class="nc" id="L124">		       copy.getComments()</span>
		       );
     
<span class="nc" id="L127">     }</span>
        public final PositionSequence peaks() {
<span class="fc" id="L129">            return peaks;</span>
        }

        public final BasicChromatogramBuilder peaks(PositionSequence peaks) {
<span class="fc" id="L133">            this.peaks = peaks;</span>
<span class="fc" id="L134">            return this;</span>
        }
        public final String id(){
<span class="nc" id="L137">        	return id;</span>
        }
        
        public BasicChromatogramBuilder id(String id){
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        	if(id ==null){</span>
<span class="nc" id="L142">        		throw new NullPointerException(&quot;id can not be null&quot;);</span>
        	}
<span class="fc" id="L144">        	this.id = id;</span>
<span class="fc" id="L145">        	return this;</span>
        }
        public NucleotideSequence basecalls() {
<span class="fc" id="L148">            return basecalls;</span>
        }

        public BasicChromatogramBuilder basecalls(NucleotideSequence basecalls) {
<span class="fc" id="L152">            this.basecalls = basecalls;</span>
<span class="fc" id="L153">            return this;</span>
        }

        public byte[] aQualities() {
<span class="fc" id="L157">            return Arrays.copyOf(aQualities, aQualities.length);</span>
        }

        public final BasicChromatogramBuilder aQualities(byte[] qualities) {
<span class="fc" id="L161">            aQualities = Arrays.copyOf(qualities, qualities.length);</span>
<span class="fc" id="L162">            return this;</span>
        }

        public byte[] cQualities() {
<span class="fc" id="L166">            return Arrays.copyOf(cQualities, cQualities.length);</span>
        }

        public BasicChromatogramBuilder cQualities(byte[] qualities) {
<span class="fc" id="L170">            cQualities = Arrays.copyOf(qualities, qualities.length);</span>
<span class="fc" id="L171">            return this;</span>
        }

        public byte[] gQualities() {
<span class="fc" id="L175">            return Arrays.copyOf(gConfidence, gConfidence.length);</span>
        }

        public BasicChromatogramBuilder gQualities(byte[] qualities) {
<span class="fc" id="L179">            gConfidence = Arrays.copyOf(qualities, qualities.length);</span>
<span class="fc" id="L180">            return this;</span>
        }

        public byte[] tQualities() {
<span class="fc" id="L184">            return Arrays.copyOf(tQualities, tQualities.length);</span>
        }

        public BasicChromatogramBuilder tQualities(byte[] qualities) {
<span class="fc" id="L188">            tQualities = Arrays.copyOf(qualities, qualities.length);</span>
<span class="fc" id="L189">            return this;</span>
        }

        public short[] aPositions() {
<span class="fc bfc" id="L193" title="All 2 branches covered.">            if(aPositions ==null){</span>
<span class="fc" id="L194">                return new short[]{};</span>
            }
<span class="fc" id="L196">            return Arrays.copyOf(aPositions, aPositions.length);</span>
        }

        public BasicChromatogramBuilder aPositions(short[] positions) {
<span class="fc" id="L200">            aPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="fc" id="L201">            return this;</span>
        }

        public short[] cPositions() {
<span class="fc bfc" id="L205" title="All 2 branches covered.">            if(cPositions ==null){</span>
<span class="fc" id="L206">                return new short[]{};</span>
            }
<span class="fc" id="L208">            return Arrays.copyOf(cPositions, cPositions.length);</span>
        }

        public BasicChromatogramBuilder cPositions(short[] positions) {
<span class="fc" id="L212">            cPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="fc" id="L213">            return this;</span>
        }

        public short[] gPositions() {
<span class="fc bfc" id="L217" title="All 2 branches covered.">            if(gPositions ==null){</span>
<span class="fc" id="L218">                return new short[]{};</span>
            }
<span class="fc" id="L220">            return Arrays.copyOf(gPositions, gPositions.length);</span>
        }

        public BasicChromatogramBuilder gPositions(short[] positions) {
<span class="fc" id="L224">            gPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="fc" id="L225">            return this;</span>
        }

        public short[] tPositions() {
<span class="fc bfc" id="L229" title="All 2 branches covered.">            if(tPositions ==null){</span>
<span class="fc" id="L230">                return new short[]{};</span>
            }
<span class="fc" id="L232">            return Arrays.copyOf(tPositions, tPositions.length);</span>
        }

        public BasicChromatogramBuilder tPositions(short[] positions) {
<span class="fc" id="L236">            tPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="fc" id="L237">            return this;</span>
        }

        public Map&lt;String,String&gt; comments() {
<span class="fc bfc" id="L241" title="All 2 branches covered.">            return comments ==null? Collections.&lt;String,String&gt;emptyMap() :new LinkedHashMap&lt;String, String&gt;(comments);</span>
        }

        public BasicChromatogramBuilder comments(Map&lt;String,String&gt; comments) {
<span class="fc" id="L245">            this.comments = new LinkedHashMap&lt;String, String&gt;(comments);</span>
<span class="fc" id="L246">            return this;</span>
        }

        private QualitySequence generateQualities(ChannelGroup channelGroup) {
<span class="fc" id="L250">        	int length = (int)basecalls.getLength();</span>
<span class="fc" id="L251">            QualitySequenceBuilder builder = new QualitySequenceBuilder(length);</span>
<span class="fc" id="L252">            int i=0;</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">            for(Nucleotide base : basecalls){</span>
<span class="fc" id="L254">            	QualitySequence qualitySequence = channelGroup.getChannel(base).getQualitySequence();</span>
            	//only read as many qualities as we have...
<span class="fc bfc" id="L256" title="All 2 branches covered.">                if(i == qualitySequence.getLength()){</span>
<span class="fc" id="L257">                	break;</span>
                }
<span class="fc" id="L259">                builder.append(qualitySequence.get(i));</span>
<span class="fc" id="L260">                i++;</span>
<span class="fc" id="L261">            }            </span>
<span class="fc" id="L262">            return  builder.build();</span>
        }
        
        public Chromatogram build() {
<span class="fc" id="L266">            final ChannelGroup channelGroup = new DefaultChannelGroup(</span>
<span class="fc" id="L267">                    new DefaultChannel(aQualities(),aPositions()),</span>
<span class="fc" id="L268">                    new DefaultChannel(cQualities(),cPositions()),</span>
<span class="fc" id="L269">                    new DefaultChannel(gQualities(),gPositions()),</span>
<span class="fc" id="L270">                    new DefaultChannel(tQualities(),tPositions()));</span>
            
<span class="fc" id="L272">            return new BasicChromatogram(id,</span>
<span class="fc" id="L273">                    basecalls(),</span>
<span class="fc" id="L274">                    generateQualities(channelGroup),                        </span>
<span class="fc" id="L275">                        peaks(),</span>
                    channelGroup,
<span class="fc" id="L277">                    comments());</span>
        }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>